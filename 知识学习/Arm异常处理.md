# Arm异常处理

## aarch64异常处理过程

- 硬件处理部分（发生异常时或主动调用触发异常指令，如svc, hvc, smc）
  - 更新SPSR_ELn，保存PSTATE信息，需要在异常结束返回时恢复该内容
  - 更新PSTATE，反映出当前处理器的状态，比如EL提升
  - 异常返回的地址被存储在ELR_ELn中
  - 跳转到异常向量表执行对应的异常处理函数
  - **注：寄存器的_ELn后缀代表在每个异常等级都有该寄存器的不同拷贝，比如SPSR_EL1和SPSR_EL2时两个不同的物理寄存器**
- 软件处理部分
  - 保存现场（上下文）
  - 根据异常类型执行对应的异常处理函数
  - 恢复现场 (上下文)
  - eret
- 硬件处理部分（执行eret）
  - 把SPSR_ELn恢复到PSTATE中
  - 把PC设置为ELR_ELn，跳转执行

## hvc

- 生成一个目标是EL2的异常。
- HVC #<imm>：其中bits(16) imm = imm16;
  - 该imm会存于ESR_EL2的imm16（bits [15:0]）。ESR_EL2：用于存储目标EL为EL2发生的异常的相关信息。