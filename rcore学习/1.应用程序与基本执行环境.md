# 应用程序与基本执行环境

## 执行环境与平台支持

在 Ubuntu 系统上，可以通过 `strace` 工具来运行一个程序并输出程序运行过程当中向内核请求的所有的系统调用及其返回值。输入`strace 可执行文件名`即可。

现代编译器工具集（以C或Rust编译器为例）的主要工作流程如下：

1. 源代码（source code） –> 预处理器（preprocessor） –> 宏展开的源代码
2. 宏展开的源代码 –> 编译器（compiler） –> 汇编程序
3. 汇编程序 –> 汇编器（assembler）–> 目标代码（object code）
4. 目标代码 –> 链接器（linker） –> 可执行文件（executables）

## 移除标准库依赖

在main.rs中需要添加两个注记：

```rust
#![no_std] // 不使用标准库
#![no_main] // 无main函数，不需要标准库做初始化工作
```

## 内核第一条指令

rcore是运行在qemu上的，qemu可以通过如下命令启动：

```
qemu-system-riscv64 \
    -machine virt \
    -nographic \
    -bios ../bootloader/rustsbi-qemu.bin \
    -device loader,file=target/riscv64gc-unknown-none-elf/release/os.bin,addr=0x80200000
```

其中-device loader可以在qemu开机前将宿主机上的文件file加载到qemu物理内存的指定位置addr上。带有.bin的文件是内核可执行文件进行加工处理得到的内核镜像。（加工处理是指剪裁掉可执行文件中的元数据）

* qemu启动流程

> 在Qemu模拟的 `virt` 硬件平台上，物理内存的起始物理地址为 `0x80000000`。

1. 在执行任何指令前，将作为bootloader的rustsbi和内核镜像分别加载到物理地址0x80000000和0x80200000上
2. CPU从0x1000地址处执行一小段汇编指令，之后跳转到物理地址0x80000000
3. 执行bootloader rustsbi，执行完成后rustsbi会自动跳转到0x80200000（rustsbi固定好的）
4. 执行内核镜像。

## 操作系统启动流程

`os/.cargo/config`指定了程序的入口函数为`__start`，其地址为0x80200000，该函数会跳转到rust_main函数中。

## 补充知识

### 程序内存布局与编译流程

程序是由两部分组成：代码部分和数据部分。这两个部分可以根据功能分成多个段，这些段就构成了程序的内存布局。例如：

![../_images/MemoryLayout.png](https://mdpics4lgw.oss-cn-beijing.aliyuncs.com/aliyun/202308191908677.png)

源代码经过编译、汇编后得到二进制的目标文件，之后不同目标文件中相同功能的段会被排在一起放在拼装后的目标文件中，之后还会进行符号的替换，替换为具体地址，这称为链接。

链接脚本linker script可以调整链接器的行为。Cargo配置文件.cargo/config中可以配置使用指定的链接脚本。

### 寄存器的保存

见：

[为内核支持函数调用 - rCore-Tutorial-Book-v3 3.6.0-alpha.1 文档 (rcore-os.cn)](http://rcore-os.cn/rCore-Tutorial-Book-v3/chapter1/5support-func-call.html)