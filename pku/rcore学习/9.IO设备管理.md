# IO设备管理学习

参考教程：[I/O设备 - rCore-Tutorial-Book-v3 3.6.0-alpha.1 文档 (rcore-os.cn)](http://rcore-os.cn/rCore-Tutorial-Book-v3/chapter9/1io-interface.html)

设计驱动程序时，可以设计这样一个层次：

1. 一个裸机环境下的驱动Crate
2. 基于该Crate的最小执行环境
3. 在操作系统内核中设计驱动程序，对接OS的其他内核模块。

本质思想就是逐层调用和封装。

设计驱动程序前，要明确驱动程序要完成哪些功能，据此来实现：

1. 设备扫描/发现

2. 设备初始化

3. 准备发给设备的命令

4. 通知设备

5. 接收设备通知

6. (可选）卸载设备驱动时回收设备驱动资源

裸机驱动需要了解硬件规范：

* UART：实际的物理设备
* Virtio设备：虚拟设备

还需了解外设与CPU是如何连接的。

> openSBI是Qemu提供的bootloader，类似于一个os了功能已经。

## IO设备

总线定义了连接在一起的设备需要共同遵守连接方式和I/O时序等，不同总线（如SPI总线、I2C总线、USB总线、PCI总线等）的连接方式和I/O时序是不同的。

![../_images/io-comm-mode.png](https://mdpics4lgw.oss-cn-beijing.aliyuncs.com/aliyun/202307281614610.png)

### DMA

![../_images/dma-steps.png](https://mdpics4lgw.oss-cn-beijing.aliyuncs.com/aliyun/202307281618616.png)

## 设备树

设备树是一种数据结构，描述计算机硬件系统的结构和功能。每个设备在其中连接到父设备上，最终通过总线构建起来形成一整个设备树。

设备树上的节点，用来描述该设备信息，包含许多键值对（属性）。常见属性有：

- compatible：表示设备的类型，可以是设备的厂商名、产品名等，如 “virtio,mmio” 指的是这个设备通过 virtio 协议、MMIO（内存映射 I/O）方式来驱动
- reg：表示设备在系统中的地址空间位置
- interrupts：表示设备支持的中断信号

一个典型的设备树如下：

![../_images/device-tree.png](https://mdpics4lgw.oss-cn-beijing.aliyuncs.com/aliyun/202309081114491.png)

### 如何读取设备树信息

bootloader会探测包括物理内存在内的所有外设，并以设备树二进制对象DTB的格式保存在物理内存中，并将保存的物理地址放在a1寄存器里，把HART ID（Hardware Thread，硬件线程，可以理解为执行的 CPU 核）放在a0寄存器里。然后跳转到OS的入口地址。

对于arceos，

## 基于virtio的IO设备抽象

virtio规范是一组通用IO设备的抽象。虚拟机（VMM或Hypervisor）提供virtio设备的实现，virtio设备有着统一的virtio接口，guest操作系统只要能够实现这些通用的接口，就可以管理和控制各种virtio设备。

guest只需要设计轻量的设备驱动程序Front-end-driver即可。hypervisor则让主机处理其实际物理硬件设备上的大部分设置、维护和处理。

![兼容不同虚拟机的外设模拟方案](http://rcore-os.cn/rCore-Tutorial-Book-v3/_images/compatable-hypervisors-io-arch.png)

本质上，virtio是一个接口，允许运行在虚拟机上的操作系统和应用软件通过访问 virtio 设备使用其主机的设备。每一类virtio设备都有自己的virtio接口，virtio接口包括了数据结构和相关API的定义。

### virtio架构

virtio 架构可以分为上中下三层：

上层：运行在Unikernel上的各种驱动程序

中层：传输层，驱动程序与虚拟设备之间的交互接口。包含2部分：virtio接口定义（virtqueue）和virtio接口实现(virtio-ring)

下层：运行在QEMU中的各种模拟的虚拟设备

![../_images/virtio-driver-device.png](http://rcore-os.cn/rCore-Tutorial-Book-v3/_images/virtio-driver-device.png)

### virtio设备特征描述

特征描述：让设备驱动能够了解设备的静态特性（可通过软件修改），从而决定是否或如何使用该设备。

设备驱动程序在初始化virtio设备时，需要根据virtio设备的特征位和配置空间来了解设备的特征，并对设备进行初始化。

#### 特征位

特征位用于表示VirtIO设备具有的各种特性和功能。其中bit0 – 23是特定设备可以使用的feature bits， bit24 – 37预给队列和feature协商机制，bit38以上保留给未来其他用途

#### 设备配置空间

用于配置设备的静态特性。

### virtio设备状态表示

状态表示：让设备驱动能够了解设备的当前动态状态，从而确定如何进行设备管理或I/O数据传输；

virtio设备状态表示包括：

1. 设备初始化过程中的设备状态域：包含6种设备状态
2. IO传输状态

### virtio设备交互机制

virtio设备交互机制包括基于Notifications的**事件通知**和基于virtqueue虚拟队列的**数据传输**。

* 事件通知

驱动程序和设备在交互过程中需要相互通知对方。

驱动程序通知设备可用`门铃 doorbell`机制，即采用PIO或MMIO方式访问设备特定寄存器，**QEMU进行拦截再通知其模拟的设备**。

设备通知驱动程序一般用**中断机制**，即在QEMU中进行中断注入，让CPU响应并执行中断处理例程，来完成对I/O执行结果的处理。

* virtqueue

virtqueue是virtio设备上进行批量数据传输的机制和抽象表示。操作系统在Qemu上运行时，virtqueue是 virtio 驱动程序和 virtio 设备访问的**同一块内存区域**。

virtqueue由三部份组成：

* 描述符表 Descriptor Table

描述符表是描述符为组成元素的数组，每个描述符描述了一个内存buffer 的address/length。而内存buffer中包含I/O请求的命令/数据（由virtio设备驱动填写），也可包含I/O完成的返回结果（由virtio设备填写）等。

buffer所在物理地址空间需要设备驱动程序在初始化时分配好，并在后续由设备驱动程序在其中填写IO传输相关的命令/数据，或者是设备返回I/O操作的结果。多个描述符（I/O操作命令，I/O操作数据块，I/O操作的返回结果）形成的描述符链(通过next指针链接)可以表示一个完整的I/O操作请求。

* 可用环 Available Ring：一种vring，记录了驱动程序发出的**I/O请求索引**，需要virtio设备进行读取并完成相关I/O操作；

可用环的每一项包含一个描述符表的索引，可用环头指针(idx)和尾指针(last_avail_idx)表示可用环的范围。

* 已用环 Used Ring：另一种vring，记录了virtio设备发出的**I/O完成索引**，需要驱动程序进行读取并对I/O操作结果进行进一步处理。

![image-20230903164227885](https://mdpics4lgw.oss-cn-beijing.aliyuncs.com/aliyun/202309031642477.png)

* 基于virtqueue进行IO操作的过程



## 设备树

设备树（Device Tree）是一种数据结构，以文本文件的形式存在，用于表示硬件系统的结构和功能。例如：

* 处理器的类型和数量
* 板载设备（存储器、网卡、显卡）的类型和数量
* 硬件接口的类型和地址信息

设备树中的节点是用来描述硬件设备的信息的。 

而操作系统就是通过这些节点上的信息来实现对设备的识别和初始化。