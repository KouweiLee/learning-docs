# 开题报告答辩稿

各位老师大家好，我是计算机学院的李国玮，指导老师是王雷老师，今天开题报告的主题是一种虚拟机监控器中VirtIO后端机制

设计与实现。接下来将从这5个方面进行汇报。

## 选题背景

虚拟机监控器，英文名为Hypervisor，是一种可以在一台物理计算机上创建并运行多台虚拟机的软件。它可以根据需要将各种硬件资源虚拟化，分配给多台虚拟机同时使用。这样多台虚拟机在Hypervisor的协调下可以共享这些硬件资源。

在这些硬件资源中，外设占主要部分，计算机通过IO操作与设备进行交互，从而与外界进行通信。因此Hypervisor需要保证在虚拟化环境下，为虚拟机提供虚拟设备，保证虚拟机都能正常地使用设备。虚拟设备根据虚拟机访问设备的方式，可以分为3种。

第一种叫全虚拟设备，它是Hypervisor根据真实硬件规范完全通过代码模拟出来的一种设备。Hypervisor会拦截虚拟机对设备的全部访问操作，模拟设备的功能。因此虚拟机中的驱动程序不需要做任何更改就直接可以使用虚拟设备，但全虚拟设备实现较为复杂，且由于CPU频繁地切换到Hypervisor中，性能很差。

第二种是直通设备，它是Hypervisor直接交给虚拟机管理和操作的设备，虚拟机访问时不需要经过Hypervisor。因此直通设备的性能接近真实设备，但难以在多个客户机之间实现共享，无法复用。

第三种是半虚拟设备，它是Hypervisor根据某种协议规定的驱动接口实现的虚拟设备，目前最广泛使用的协议是Virtio，它允许虚拟机每次陷入Hypervisor时可以提交多个IO请求，相比全虚拟设备可以减少陷入次数，提高了IO性能。

Virtio协议规定了两套驱动接口，其中控制面接口定义了设备配置空间的布局，用于驱动与设备之间进行通信协商，以MMIO或PCI方式呈现给虚拟机。数据面接口又被称为Virtqueue，是虚拟机和Hypervisor之间的一片共享内存区域，用于存放客户机产生的IO请求以及Hypervisor完成IO请求后的结果信息。目前Virtio协议的应用已经相当广泛，支持十几种常见外设，且Linux、Windows等操作系统均实现了Virito驱动程序。因此，通过为Hypervisor研究和实现一套Virtio设备，可以为虚拟机提供与现有虚拟化平台兼容的高性能、低延迟、复用性强的虚拟设备，带来更加高效的IO通信能力。而且还可以推动虚拟化技术的发展，促进虚拟化应用云计算的普及。

## 研究现状

目前已有许多Hypervisor根据自身需求按照Virtio标准实现了Virtio设备，以下介绍3个典型的Hypervisor。

QEMU是一个硬件仿真器和模拟器，本质上是一个Linux用户程序，配合KVM可以高效运行多种虚拟机。当Virtio驱动程序发出IO请求时，会陷入到KVM并交给QEMU进行处理，最终会通过POSIX标准接口函数操作真实设备。QEMU的Virtio设备已经相当成熟，性能很好，但无法脱离Linux宿主机环境和KVM。

ACRN是一个在x86体系结构下的Hypervisor。它的特点是通过一个称为Service VM的虚拟机启动一个Device Model进程，由该进程提供Virtio设备的后端实现。因此当其他虚拟机使用Virtio设备时，则必须通过一个很长的通信路径发给Device Model进程，性能较差

Rust-Shyper是ARM体系结构下面向嵌入式场景的Hypervisor，其Virtio设备的实现位于Hypervisor层，通过利用Linux内核驱动操作外设简化了Virtio设备实现的复杂度。但Hypervisor层的代码量大，较为复杂。

## 研究内容

本毕设的研究基础是矽望开源社区开发的轻量级虚拟机监控器hvisor，其基于Armv8体系结构，面向嵌入式场景。目前hvisor仅可提供直通设备，无法提供可复用的虚拟设备。因此本毕设的研究目标是为hvisor实现virtio磁盘和网络设备。由于hvisor轻量级特性的限制，virtio设备不能在hypervisor中实现。因此思路是在hvisor中一个名为root linux管理虚拟机中将virtio设备实现为一个守护进程，hvisor作为驱动和设备之间传递信息的跳板。经过一定的设计和优化，既可以保证hvisor代码轻量，同时提供性能较好的虚拟设备

hvisor的Virtio设备实现分为通信跳板，Virtio守护进程, 内核服务模块三个部分。

通信跳板是其他虚拟机Virtio驱动和root linux上设备交互的桥梁。包含2个队列，分别存放由驱动发出的交互命令和设备返回的状态结果，两个队列位于Hypervisor与Virtio守护进程共享的内存区域中。

Virtio守护进程是Virtio设备的具体实现，该进程会从IO请求队列中取出IO命令，分发到对应的后端处理。完成IO操作后，会通过IO结果队列返回结果并通知内核模块。

Hypervisor内核服务模块是Virtio守护进程与Hypervisor通信的桥梁, 主要负责为Virtio守护进程和Hypervisor之间建立共享内存区域, 存放IO请求和IO结果队列。 此外当Virtio守护进程完成IO请求并通知HSM后, HSM会通过hypercall通知Hypervisor。

## 拟解决的关键问题

本毕设要解决的第一个关键问题是，Virtio设备在用户态的实现。设备的控制面接口采用MMIO方式呈现，数据面通过Virtqueue共享内存与驱动程序进行数据传输。Virtio设备由于是Linux上的一个进程，因此最终通过Linux接口函数操作真实设备。。。

第二个关键问题是，如何将虚拟机访问设备的交互请求发给root linux，root linux又如何将结果返回给对应的虚拟机。为了简化通信路径的长度，本毕设采用2个队列来存放虚拟机产生的IO请求和结果。这两个队列的实现采用生产者消费者模型，。。。

